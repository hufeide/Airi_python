
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>AIRI Inner Mind</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
          sans-serif;
        margin: 0;
        padding: 24px;
        background: #0f172a;
        color: #e5e7eb;
      }
      h2 {
        margin-bottom: 8px;
      }
      .layout {
        display: grid;
        grid-template-columns: 1.2fr 1.3fr;
        gap: 16px;
        margin-top: 12px;
      }
      .panel {
        background: #020617;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.85);
        border: 1px solid #1f2937;
      }
      .panel h3 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 15px;
        color: #9ca3af;
      }
      #messages {
        max-height: 360px;
        overflow-y: auto;
        font-size: 14px;
      }
      .msg {
        margin-bottom: 10px;
        padding: 8px 10px;
        border-radius: 8px;
      }
      .msg.me {
        background: #0f766e;
        margin-left: 40px;
      }
      .msg.bot {
        background: #1f2933;
        margin-right: 40px;
      }
      .msg small {
        display: block;
        opacity: 0.7;
        font-size: 11px;
        margin-top: 4px;
      }
      #mind {
        max-height: 400px;
        overflow-y: auto;
        font-size: 12px;
        line-height: 1.4;
      }
      .trace-item {
        margin-bottom: 6px;
        padding-bottom: 6px;
        border-bottom: 1px dashed #1f2937;
      }
      .trace-node {
        font-weight: 600;
        color: #fbbf24;
      }
      .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .status {
        font-size: 12px;
        color: #9ca3af;
      }
      .status span {
        margin-left: 10px;
      }
      .status-label {
        color: #6b7280;
      }
      input,
      button {
        font-family: inherit;
      }
      .input-row {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      #userInput {
        flex: 1;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
      }
      #userId {
        width: 120px;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
        font-size: 12px;
      }
      #sendBtn {
        padding: 0 16px;
        border-radius: 8px;
        border: none;
        background: #22c55e;
        color: #020617;
        font-weight: 600;
        cursor: pointer;
      }
      #sendBtn:disabled {
        opacity: 0.6;
        cursor: default;
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <h2>AIRI Inner Mind</h2>
      <div class="status">
        <span class="status-label">信任:</span><span id="trust">-</span>
        <span class="status-label">关系:</span><span id="relationship">-</span>
        <span class="status-label">梦境:</span><span id="dream">-</span>
      </div>
    </div>

    <div class="layout">
      <div class="panel">
        <h3>对话</h3>
        <div id="messages"></div>
        <div class="input-row">
          <input
            id="userId"
            placeholder="user_id"
            value="demo"
            title="用于区分不同会话的 user_id"
          />
          <input
            id="userInput"
            placeholder="输入你的想法、目标、问题..."
          />
          <button id="sendBtn">发送</button>
        </div>
      </div>

      <div class="panel">
        <h3>Inner Mind Trace</h3>
        <div id="mind"></div>
      </div>
    </div>

    <script>
      const messagesEl = document.getElementById("messages");
      const mindEl = document.getElementById("mind");
      const inputEl = document.getElementById("userInput");
      const userIdEl = document.getElementById("userId");
      const sendBtn = document.getElementById("sendBtn");
      const trustEl = document.getElementById("trust");
      const relationshipEl = document.getElementById("relationship");
      const dreamEl = document.getElementById("dream");

      function appendMessage(role, text) {
        const div = document.createElement("div");
        div.className = "msg " + role;
        div.innerHTML =
          "<div>" +
          text +
          "</div><small>" +
          (role === "me" ? "你" : "AIRI") +
          "</small>";
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function sendMessage() {
        const text = inputEl.value.trim();
        const userId = userIdEl.value.trim() || "demo";
        if (!text) return;
        inputEl.value = "";
        appendMessage("me", text);
        sendBtn.disabled = true;

        try {
          const params = new URLSearchParams({
            user_id: userId,
            text: text,
          });
          const res = await fetch("/chat?" + params.toString(), {
            method: "POST",
          });
          const data = await res.json();
          appendMessage("bot", data.reply || "(no reply)");
          trustEl.textContent =
            data.trust !== undefined ? data.trust.toFixed(2) : "-";
          relationshipEl.textContent =
            data.relationship !== undefined
              ? data.relationship.toFixed(2)
              : "-";
          dreamEl.textContent = data.dream || "-";
          refreshTrace();
        } catch (e) {
          appendMessage("bot", "请求失败: " + e);
        } finally {
          sendBtn.disabled = false;
          inputEl.focus();
        }
      }

      async function refreshTrace() {
        try {
          const res = await fetch("/trace");
          const data = await res.json();
          let html = "";
          data.forEach((x) => {
            html +=
              '<div class="trace-item"><span class="trace-node">' +
              x.node +
              "</span>: " +
              JSON.stringify(x.state) +
              "</div>";
          });
          mindEl.innerHTML = html || "<em>暂无轨迹</em>";
        } catch (e) {
          mindEl.innerHTML = "<em>无法获取轨迹: " + e + "</em>";
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // 初次加载时拉一次 trace，之后每 3 秒自动刷新
      refreshTrace();
      setInterval(refreshTrace, 3000);
    </script>
  </body>
</html>
